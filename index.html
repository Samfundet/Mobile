
<!doctype html>

<html>

<head>

	<meta charset="utf-8">
	<meta content='width=device-width, initial-scale=1, minimum-scale=1' name='viewport'>

	<title>Samfundet</title>

	<script src="http://datejs.googlecode.com/files/date.js"></script>
	<script src="http://ijp.googlecode.com/files/ijp-0.6.js"></script>
	<script src="domdidom.js"></script>

	<script language="javascript">

		function categoryToType(cat) 
		{ 
			return 	{
				Film: 'f',
				Excenteraften: 'p',
				Teater: 'y',
				Samfundsmøte: 'r',
				Happening: 'r',
				Konsert: 'p',
				Fotballkamp: 'g',
				DJ: 'p',
				Quiz: 'y',
				Temafest: 'p'
			}[cat]; 
		}

		function getWeekAndDay(date)
		{
			var week_day = date.getDayOfYear() - date.last().monday().getDayOfYear();
			//if (date.is().monday()) week_day = 0;
			var week_nr = date.getWeekOfYear();
			if (week_day==7) { week_day=0; week_nr+=1; }
			var ret = {week:week_nr, day:week_day};
			return ret;
		}

		function mondayOfWeek(week_nr)
		{
			var today_wd = getWeekAndDay(Date.today());

			var delta_weeks = week_nr - today_wd.week;
			var delta_days = 0 - today_wd.day;
			var ret = Date.today();
			ret.addDays(7 * delta_weeks + delta_days);
			return ret;
		}
		function parseDatetime(datetime)
		{
			var v = datetime;
			return v.substring(0,4)+"/"+v.substring(4,6)+"/"+v.substring(6,8) + " " 
			     + v.substring(9,11) + ":" + v.substring(11,13) + ":" + v.substring(13,15); 
		}

	    function get(url, success, failure)
	    {
	    	var req = new XMLHttpRequest();
	    	req.onreadystatechange = function() 
	    	{
				if (req.readyState == 4) 
					success(req.responseText);
				else
					failure(req.responseText);
			};
			req.open("GET", url, true);
			req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
			req.send(null); 
    	}



		/*
		HTMLElement.prototype.toggle = function()
		{
			if ("old_display" in this)
			{
				this.style.display = this.old_display;
				delete this.old_display;
				var counter = 0;
				var elm = this;

				elm.style.overflow = "hidden";
				(function anim()
				{
					elm.style.height = counter+"px";
					counter += 20;
					if (counter >= elm.measureHeight())
						elm.style.height = "";
					else
		                window.setTimeout(anim, 1000 / 24);
				})();
			}
			else
			{
				var elm = this;
				var counter = elm.measureHeight();

				elm.style.overflow = "hidden";
				(function anim()
				{
					elm.style.height = counter+"px";
					counter -= 20;
					if (counter <= 0)
					{
						elm.old_display = elm.style.display;
						elm.style.display = "none";
						elm.style.height = "";
					}
					else
		                window.setTimeout(anim, 1000 / 24);
				})();

				
			}
		};*/

		HTMLElement.prototype.toggle = function()
		{
			if (this.style.height == "0px")
			{
				this.css({height: this.measureHeight()+"px" });
				return true;
			}
			else
			{
				this.css({height: "0px" });			
				return false;
			}
		};

		document.createWeek = function()
		{
			var week_dom = document.createElement("section");
			week_dom.setAttribute("class", "weekview");


			var goto_previous_week = function() {};
			var goto_current_week = function() {};
			var goto_next_week = function() {};


			{
				var nav = week_dom.appendElement("nav", { class: "top" });
				
				nav.appendElement("button", "Forrige uke", { 
					"class": "radius_tl",
					"data-action": "previous",
				}).onclick = goto_previous_week;

				nav.appendElement("button", "Uke 23").onclick = goto_current_week;

				nav.appendElement("button", "Neste uke", {
					"class": "radius_tr",
					"data-action": "next",
				}).onclick = goto_next_week;
			}

			var days = week_dom.appendElement("div");

			{
				var nav = week_dom.appendElement("nav", { class: "bottom" });
				
				nav.appendElement("button", "Forrige uke", { 
					"class": "radius_bl",
					"data-action": "previous",
				}).onclick = goto_previous_week;

				nav.appendElement("button", "Uke 23").onclick = goto_current_week;

				nav.appendElement("button", "Neste uke", {
					"class": "radius_br",
					"data-action": "next",
				}).onclick = goto_next_week;
			}

			week_dom.addDay = function(date)
			{
				var day = days.appendElement("article", { class: "day grayed" });

				day.header = day.appendElement("header");
				var h2 = day.header.appendElement("h2");
				var time = h2.appendElement("time", { datetime: date });
				time.appendElement("strong", date.toString("dddd"));
				time.appendText(" " + date.toString("d. MMMM"));

				day.eventTypes = {};
				day.eventTypeCounts = {};

				day.event_list = day.appendElement("ul", {"class":"notop nobottom"});

				//day.event_list.hide();
				
				day.event_list.css({
					height: "0px",
					overflow: "hidden"
				});

				day.event_list.css3({transition: "height 0.4s ease-in-out"});
				
				day.header.onclick = function() 
				{ 
					if (day.event_list.toggle()) 
						day.event_list.removeClass("notop nobottom"); 
					else
						window.setTimeout(function(){day.event_list.addClass("notop nobottom");}, 200);
				};
				
				day.addEvent = function(event)
				{
					var type = categoryToType(event.categories[0].value);

					var li = day.event_list.appendElement("li", { class: "cat-"+type });

					var eventart = li.appendElement("article", { class: "event cat-"+type });

					eventart.header = eventart.appendElement("header");
					eventart.header.appendElement("time", event.date.toString("HH:mm"), { datetime: event.date });
					eventart.header.appendElement("h3", event.summary.value);
					eventart.header.appendElement("h4", event.categories[0].value+' i '+event.location.value);

					eventart.appendElement("p", event.description.value);
					
					if (!(type in day.eventTypeCounts))
					{
						day.eventTypeCounts[type] = 1;
						var bullet = h2.appendElement("span", "1", { class: "bullet "+"bg_"+type });
						day.removeClass("grayed")
						day.eventTypes[type] = bullet;
					}
					else
					{
						day.eventTypeCounts[type] += 1;
						day.eventTypes[type].innerHTML = day.eventTypeCounts[type]; 
					}
					return eventart;
				};
				return day;
			};


			return week_dom;
		};

var current_week = getWeekAndDay(Date.today()).week;
var current_year = Date.today().toString("yyyy");

/*
	 	window.requestAnimFrame = (function(){
	      return  window.requestAnimationFrame       || 
	              window.webkitRequestAnimationFrame || 
	              window.mozRequestAnimationFrame    || 
	              window.oRequestAnimationFrame      || 
	              window.msRequestAnimationFrame     || 
	              function( callback ){
	                window.setTimeout(callback, 1000 / 60);
	              };
	    })();
*/





		cache =
		{
			week: {},
			events: {},
			clearWeek: function(weekno)
			{
				this.week[weekno] = [[],[],[],[],[],[],[]];
			},
			addEvent: function(item)
			{
				var wd = getWeekAndDay(item.date);
				this.events[item.uid.value] = item;
				if (!this.week[wd.week]) this.clearWeek(wd.week);
				//alert("added "+item.uid.value+" on week"+wd.week+"day"+wd.day);
				this.week[wd.week][wd.day].push(item.uid.value);
			},
			getDay: function(weekno, dayno)
			{
				//alert("fetching from week"+weekno+"day"+dayno)
				var ret = [];
				var w = this.week[weekno];
				for (uid in w[dayno])
					ret.push(this.events[w[dayno][uid]]);
				return ret;
			}
		};

		events = 
	    {
	    	fetch: function(from, to, success, failure)
	    	{
				var ical_base_url = "/arrangement/ical_interval";
				var ical_url = ical_base_url+"/from/"+from.toString("yyyy/MM/dd")+"/to/"+to.toString("yyyy/MM/dd");
				get(ical_url, function(response)
				{
					icalParser.parseIcal(response);
					var events = icalParser.ical.events;
					success(events);
				}, function(response)
				{
					if (failure) failure();
				});
			},
			fetchWeek: function(weekno, success, failure)
			{
				var from = mondayOfWeek(weekno);
				var to = from.clone();
				to.addDays(7);
				this.fetch(from, to, success, failure);
			}

		}


/*
		updateWeekCAche()
		{

		}

*/


		function onLoad()
		{
			main_dom = document.getElementById("main");
			var weekview = document.createWeek();
			main_dom.appendChild(weekview);
			settings_dom = document.getElementById("settings");
			

			weekno = current_week;

			events.fetchWeek(weekno, function(events)
			{
				cache.clearWeek(weekno);
				for (i in events)
				{
					var item = events[i];
					var datestr = parseDatetime(item.dtstart.value);
					item.date = Date.parse(datestr);
					item.time = item.date.toString("HH:mm");
					cache.addEvent(item);
				}

				var date = mondayOfWeek(weekno);
				for (i = 0; i<7; i++)
				{
					var day = weekview.addDay(date);
					var events = cache.getDay(weekno, i);
					for (e in events)
						day.addEvent(events[e]);
					date.addDays(1);
				}

			});
		    settings_dom.css3({transform: "translateX(-100px)"});
			main_dom.css3({transform: "translateX(0px)"});
			settings_dom.css3({transition: "-webkit-transform 0.4s ease-out"});
			main_dom.css3({transition: "-webkit-transform 0.4s ease-out"});
		}


	    var toggler = true;

		yo = false;
		function onClick()
		{
				
			if (toggler)
			{
			    settings_dom.style.width = "215px";
				settings_dom.css3({transform: "translateX(0px)"});
				main_dom.css3({transform: "translateX(225px)"});
			}
			else
			{
			    settings_dom.css3({transform: "translateX(-100px)"});
				main_dom.css3({transform: "translateX(0px)"});
			    window.setTimeout(function() { 
				    settings_dom.style.width = "0px";
			    }, 400);
			}
			toggler = !toggler;
		}
		
	</script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<style type="text/css">

	</style>
</head>
<body onload="onLoad()" >


<section class="settings" id="settings">
	<fieldset class="search">
		<input type="text" placeholder="Søk i arrangementer">
	</fieldset>	
	<fieldset>
		<legend >Vis kategorier</legend>
		<button class="notop">
			<span class="circle bg_p"></span>
			Konsert og Uteliv</button>
		<button>
			<span class="circle bg_y"></span>
			Kultur og Underholdning</button>
		<button>
			<span class="circle bg_r"></span>
			Samfundsm&oslash;te og Debatt</button>
		<button>
			<span class="circle bg_y"></span>
			Film</button>
		<button class="nobottom ">
			<span class="circle bg_g"></span> Fotball og Sport</button>
	</fieldset>
	<fieldset>
		<legend>Preferanser</legend>
		<button class="notop notop"><span class="circle bg_f"></span>Fancy effekter</button>
		<button class="nobottom nobottom"><span class="circle bg_f"></span>Bruk mobilversjon</button>
	</fieldset>
</section>

<section class="main" id="main">

<header class="top">
	<button class="toggle_settings" onclick="onClick();">&nbsp;</button>
	<h1><img src="http://www.samfundet.no/public/mobile-old/logo.png" alt="Samfundet"></h1>
</header>

</section>
</body>
</html>